#!/usr/bin/env python3

import json
import re
from pathlib import Path


def extract_flow_columns(filename):
    try:
        with open(filename, "r") as file:
            content = file.read()
    except FileNotFoundError:
        print(f"Error: File '{filename}' not found.")
        return []

    pattern = r"const FlowColumns:.*?=\s*{([^}]*)}"
    match = re.search(pattern, content, re.DOTALL)

    if match:
        columns_text = match.group(1)
        columns_text = re.sub(r"//.*$", "", columns_text, flags=re.MULTILINE)
        columns = re.findall(r"\b(\w+),?", columns_text)
        return columns
    return []


def generate_web_columns():
    here = Path(__file__).parent.absolute()

    filename = here / "../src/js/components/FlowTable/FlowColumns.tsx"
    AVAILABLE_WEB_COLUMNS = extract_flow_columns(filename)
    DEFAULT_WEB_COLUMNS = ["tls", "icon", "path", "method", "status", "size", "time"]

    output = f"""
# Auto-generated by generate_web_columns.py
AVAILABLE_WEB_COLUMNS = {json.dumps(AVAILABLE_WEB_COLUMNS, indent=4)}
DEFAULT_WEB_COLUMNS = {json.dumps(DEFAULT_WEB_COLUMNS, indent=4)}
"""

    output_path = Path("mitmproxy/tools/web/web_columns.py")
    with open(output_path, "w") as file:
        file.write(output.strip())

    print(f"Generated {output_path}")


if __name__ == "__main__":
    generate_web_columns()
