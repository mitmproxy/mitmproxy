# Oximy Release Workflow
#
# This workflow builds and releases the Oximy desktop applications for macOS and Windows.
# It uses the unified build-prod.sh script - the same script used for local builds.
#
# Trigger: Manual dispatch with version number input
#
# Required Secrets:
#   macOS:
#     - APPLE_CERTIFICATE: Base64-encoded Developer ID certificate (.p12)
#     - APPLE_CERTIFICATE_PASSWORD: Password for the certificate
#     - APPLE_ID: Apple ID email for notarization
#     - APPLE_APP_PASSWORD: App-specific password for notarization
#     - INSTALLER_CERTIFICATE: Base64-encoded Developer ID Installer certificate (.p12)
#     - INSTALLER_CERTIFICATE_PASSWORD: Password for the installer certificate
#     - INSTALLER_CERT: Developer ID Installer certificate name for PKG signing
#     - BETTERSTACK_ERRORS_DSN: (Optional) Better Stack Errors Sentry-compatible DSN for crash reporting
#     - BETTERSTACK_LOGS_TOKEN: (Optional) Better Stack Logs source token
#     - BETTERSTACK_LOGS_HOST: (Optional) Better Stack Logs ingesting host
#
#   Windows:
#     - (No secrets required for unsigned builds)

name: Oximy Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.0)'
        required: true
        type: string
      min_supported:
        description: 'Minimum supported version (bump on breaking changes)'
        required: false
        default: '0.0.3'
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  VERSION: ${{ inputs.version }}

jobs:
  # ===========================================
  # Preflight — validate version & generate changelog
  # ===========================================
  preflight:
    name: Preflight
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for duplicate version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="oximy-v${{ inputs.version }}"
          if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "::error::Version ${{ inputs.version }} already exists (tag $TAG). Use a different version number."
            exit 1
          fi
          # Also check if a GitHub release already exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "::error::GitHub release $TAG already exists. Delete it first or use a different version."
            exit 1
          fi
          echo "Version ${{ inputs.version }} is available."

      - name: Generate changelog
        id: changelog
        run: |
          # Find the previous release tag (most recent oximy-v* tag)
          PREV_TAG=$(git tag --list 'oximy-v*' --sort=-v:refname | head -1)

          if [ -z "$PREV_TAG" ]; then
            echo "No previous release tag found — including all commits."
            LOG=$(git log --pretty=format:"- %s (%h)" --no-merges -50)
          else
            echo "Previous release: $PREV_TAG"
            LOG=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" --no-merges)
          fi

          if [ -z "$LOG" ]; then
            LOG="- No changes since $PREV_TAG"
          fi

          # Write to output (multiline)
          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$LOG"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

          echo "--- Generated Changelog ---"
          echo "$LOG"

  # ===========================================
  # Build macOS App (Universal Binary: ARM64 + x86_64)
  # ===========================================
  build-macos:
    name: Build macOS
    needs: [preflight]
    runs-on: macos-14
    outputs:
      dmg-name: ${{ steps.build.outputs.dmg-name }}
      pkg-name: ${{ steps.build.outputs.pkg-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Import code signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Import installer signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.INSTALLER_CERTIFICATE }}
          p12-password: ${{ secrets.INSTALLER_CERTIFICATE_PASSWORD }}
          create-keychain: false

      - name: Setup Node.js (for create-dmg)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install create-dmg
        run: npm install -g create-dmg

      - name: Build macOS app
        id: build
        env:
          VERSION: ${{ inputs.version }}
          DEVELOPER_ID: "Developer ID Application: Oximy, Inc. (K6H6LCASRA)"
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          TEAM_ID: "K6H6LCASRA"
          INSTALLER_CERT: ${{ secrets.INSTALLER_CERT }}
          BETTERSTACK_ERRORS_DSN: ${{ secrets.BETTERSTACK_ERRORS_DSN }}
          BETTERSTACK_LOGS_TOKEN: ${{ secrets.BETTERSTACK_LOGS_TOKEN }}
          BETTERSTACK_LOGS_HOST: ${{ secrets.BETTERSTACK_LOGS_HOST }}
        run: |
          chmod +x build-prod.sh
          ./build-prod.sh mac --version "$VERSION"
          echo "dmg-name=Oximy-$VERSION.dmg" >> $GITHUB_OUTPUT
          echo "pkg-name=Oximy-$VERSION.pkg" >> $GITHUB_OUTPUT

      # Note: dSYM upload removed — Better Stack Errors doesn't support symbolication upload.
      # Native crash stack traces will show unsymbolicated addresses.

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            OximyMac/build/Oximy-${{ inputs.version }}.dmg
            OximyMac/build/Oximy-${{ inputs.version }}.pkg
          retention-days: 30

  # ===========================================
  # Build Windows App with Inno Setup Installer
  # ===========================================
  build-windows:
    name: Build Windows
    needs: [preflight]
    runs-on: windows-latest
    outputs:
      setup-name: ${{ steps.build.outputs.setup-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Validate version format
        run: |
          $version = "${{ inputs.version }}"
          $semverPattern = '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*)?$'
          if ($version -notmatch $semverPattern) {
              Write-Error "Invalid version format: '$version'. Must be SemVer2 (e.g., 1.0.0, 1.2.3-beta.1)"
              exit 1
          }
          Write-Host "Version '$version' is valid"

      - name: Build Windows app
        id: build
        env:
          VERSION: ${{ inputs.version }}
          BETTERSTACK_ERRORS_DSN: ${{ secrets.BETTERSTACK_ERRORS_DSN }}
          BETTERSTACK_LOGS_TOKEN: ${{ secrets.BETTERSTACK_LOGS_TOKEN }}
          BETTERSTACK_LOGS_HOST: ${{ secrets.BETTERSTACK_LOGS_HOST }}
        run: |
          # Use the unified build script via bash (Git Bash on Windows)
          bash -c "./build-prod.sh windows --version $env:VERSION"
          echo "setup-name=OximySetup-${{ inputs.version }}.exe" >> $env:GITHUB_OUTPUT

      - name: Create Inno Setup installer (optional)
        working-directory: OximyWindows
        run: |
          $iss = "installer\OximySetup.iss"
          if (Test-Path $iss) {
            (Get-Content $iss) -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ inputs.version }}"' | Set-Content $iss
            $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
            if (Test-Path $innoPath) {
              & $innoPath $iss
            } else {
              Write-Warning "Inno Setup not found, skipping installer creation"
            }
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: OximyWindows/installer/Output/*.exe
          retention-days: 30

  # ===========================================
  # Create GitHub Release
  # ===========================================
  create-release:
    name: Create Release
    needs: [preflight, build-macos, build-windows]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: release-assets/macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release-assets/windows

      - name: List release assets
        run: |
          echo "=== macOS ==="
          ls -la release-assets/macos/ || echo "No macOS files"
          echo ""
          echo "=== Windows ==="
          ls -la release-assets/windows/ || echo "No Windows files"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: oximy-v${{ inputs.version }}
          name: Oximy v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            release-assets/macos/Oximy-${{ inputs.version }}.dmg
            release-assets/macos/Oximy-${{ inputs.version }}.pkg
            release-assets/windows/*.exe
          body: |
            ## Oximy v${{ inputs.version }}

            ### Downloads

            | Platform | Download | Use |
            |----------|----------|-----|
            | macOS (Apple Silicon & Intel) | [Oximy-${{ inputs.version }}.dmg](https://github.com/OximyHQ/sensor/releases/download/oximy-v${{ inputs.version }}/Oximy-${{ inputs.version }}.dmg) | First install |
            | macOS (PKG Installer) | [Oximy-${{ inputs.version }}.pkg](https://github.com/OximyHQ/sensor/releases/download/oximy-v${{ inputs.version }}/Oximy-${{ inputs.version }}.pkg) | Updates & MDM |
            | Windows (64-bit) | [OximySetup-${{ inputs.version }}.exe](https://github.com/OximyHQ/sensor/releases/download/oximy-v${{ inputs.version }}/OximySetup-${{ inputs.version }}.exe) | Install & Update |

            ### What's Changed

            ${{ needs.preflight.outputs.changelog }}

            ### macOS Compatibility

            - **Apple Silicon (M1/M2/M3/M4)**: Native ARM64 binary
            - **Intel Macs**: Native x86_64 binary (Universal Binary)

            ---

            **Full Changelog**: https://github.com/OximyHQ/sensor/compare/...oximy-v${{ inputs.version }}

      - name: Update latest tag
        if: ${{ inputs.prerelease == false }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Copy assets with fixed names so the download URLs never change
          mkdir -p release-assets/latest
          cp release-assets/macos/Oximy-${{ inputs.version }}.dmg release-assets/latest/Oximy.dmg
          cp release-assets/macos/Oximy-${{ inputs.version }}.pkg release-assets/latest/Oximy.pkg
          # Copy Windows installer if it exists
          if ls release-assets/windows/*.exe 1>/dev/null 2>&1; then
            cp release-assets/windows/*.exe release-assets/latest/OximySetup.exe
          fi

          # Generate version.json for in-app update checks
          cat > release-assets/latest/version.json << VJEOF
          {
            "latest": "${{ inputs.version }}",
            "min_supported": "${{ inputs.min_supported }}",
            "download": {
              "macos": "https://github.com/OximyHQ/sensor/releases/download/latest/Oximy.pkg",
              "windows": "https://github.com/OximyHQ/sensor/releases/download/latest/OximySetup.exe"
            }
          }
          VJEOF

          # Delete existing 'latest' release if it exists
          gh release delete latest --yes 2>/dev/null || true
          # Force-move the 'latest' git tag to this commit
          git tag -f latest
          git push origin latest --force
          # Build the file list (only include assets that exist)
          ASSETS="release-assets/latest/Oximy.dmg release-assets/latest/Oximy.pkg release-assets/latest/version.json"
          if [ -f release-assets/latest/OximySetup.exe ]; then
            ASSETS="$ASSETS release-assets/latest/OximySetup.exe"
          fi

          # Create a 'latest' release with fixed-name assets
          gh release create latest \
            --title "Latest Stable — Oximy v${{ inputs.version }}" \
            --notes "This always points to the most recent stable release. Current: **v${{ inputs.version }}**

          ## Download

          | Platform | Link | Use |
          |----------|------|-----|
          | macOS | [Oximy.dmg](https://github.com/OximyHQ/sensor/releases/download/latest/Oximy.dmg) | First install |
          | macOS | [Oximy.pkg](https://github.com/OximyHQ/sensor/releases/download/latest/Oximy.pkg) | Updates & MDM |
          | Windows | [OximySetup.exe](https://github.com/OximyHQ/sensor/releases/download/latest/OximySetup.exe) | Install & Update |

          ## Auto-Update

          Apps check [version.json](https://github.com/OximyHQ/sensor/releases/download/latest/version.json) on startup." \
            --latest \
            $ASSETS

      - name: Summary
        run: |
          echo "## Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: oximy-v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release**: ${{ inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "- [macOS DMG](https://github.com/OximyHQ/sensor/releases/download/oximy-v${{ inputs.version }}/Oximy-${{ inputs.version }}.dmg)" >> $GITHUB_STEP_SUMMARY
          echo "- [macOS PKG](https://github.com/OximyHQ/sensor/releases/download/oximy-v${{ inputs.version }}/Oximy-${{ inputs.version }}.pkg)" >> $GITHUB_STEP_SUMMARY
          echo "- [Windows Installer](https://github.com/OximyHQ/sensor/releases/download/oximy-v${{ inputs.version }}/OximySetup-${{ inputs.version }}.exe)" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/oximy-v${{ inputs.version }}"
          TRIGGERED_BY="${{ github.actor }}"

          if [ "${{ job.status }}" = "success" ]; then
            COLOR="#22c55e"
            TITLE=":white_check_mark: Sensor release v${{ inputs.version }} succeeded"
            LINKS=":package: <${RELEASE_URL}|View release> · <https://github.com/${REPO}/releases/tag/latest|latest tag>"
            AUTO_UPDATE="\n:arrows_counterclockwise: *Auto-update:* \`version.json\` updated — running apps will see this on next launch"
            ARTIFACTS="\n:apple: DMG + PKG (signed, notarized) · :window: EXE installer"
          else
            COLOR="#ef4444"
            TITLE=":x: Sensor release v${{ inputs.version }} failed"
            LINKS=":warning: <${RUN_URL}|View build logs>"
            AUTO_UPDATE=""
            ARTIFACTS=""
          fi

          PRERELEASE_TAG=""
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            PRERELEASE_TAG="\n:test_tube: *Pre-release* — not tagged as latest, no auto-update notification"
            AUTO_UPDATE=""
          fi

          curl -sf "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "attachments": [
              {
                "color": "${COLOR}",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*${TITLE}*\n\n:package: *Repo:* \`${REPO}\`\n:label: *Version:* \`v${{ inputs.version }}\`\n:bust_in_silhouette: *Triggered by:* ${TRIGGERED_BY}\n${LINKS}${ARTIFACTS}${AUTO_UPDATE}${PRERELEASE_TAG}"
                    }
                  }
                ]
              }
            ]
          }
          EOF
