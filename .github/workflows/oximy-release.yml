# Oximy Release Workflow
#
# This workflow builds and releases the Oximy desktop applications for macOS and Windows.
# It uses the unified build-prod.sh script - the same script used for local builds.
#
# Trigger: Manual dispatch with version number input
#
# Required Secrets:
#   macOS:
#     - APPLE_CERTIFICATE: Base64-encoded Developer ID certificate (.p12)
#     - APPLE_CERTIFICATE_PASSWORD: Password for the certificate
#     - APPLE_ID: Apple ID email for notarization
#     - APPLE_APP_PASSWORD: App-specific password for notarization
#     - SPARKLE_PRIVATE_KEY: EdDSA private key for Sparkle update signing
#     - SPARKLE_PUBLIC_KEY: EdDSA public key for Info.plist
#     - SENTRY_DSN: (Optional) Sentry DSN for crash reporting
#
#   Windows:
#     - (No secrets required for unsigned builds)

name: Oximy Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  VERSION: ${{ inputs.version }}

jobs:
  # ===========================================
  # Build macOS App (Universal Binary: ARM64 + x86_64)
  # ===========================================
  build-macos:
    name: Build macOS
    runs-on: macos-14
    outputs:
      dmg-name: ${{ steps.build.outputs.dmg-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Import code signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Setup Node.js (for create-dmg)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install create-dmg
        run: npm install -g create-dmg

      - name: Build macOS app
        id: build
        env:
          VERSION: ${{ inputs.version }}
          DEVELOPER_ID: "Developer ID Application: Oximy, Inc. (K6H6LCASRA)"
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          TEAM_ID: "K6H6LCASRA"
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
          SPARKLE_PUBLIC_KEY: ${{ secrets.SPARKLE_PUBLIC_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          chmod +x build-prod.sh
          ./build-prod.sh mac --version "$VERSION"
          echo "dmg-name=Oximy-$VERSION.dmg" >> $GITHUB_OUTPUT

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            OximyMac/build/Oximy-${{ inputs.version }}.dmg
            OximyMac/build/appcast.xml
          retention-days: 30

  # ===========================================
  # Build Windows App with Velopack
  # ===========================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    outputs:
      setup-name: ${{ steps.build.outputs.setup-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk

      - name: Validate version format
        run: |
          $version = "${{ inputs.version }}"
          $semverPattern = '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*)?$'
          if ($version -notmatch $semverPattern) {
              Write-Error "Invalid version format: '$version'. Must be SemVer2 (e.g., 1.0.0, 1.2.3-beta.1)"
              exit 1
          }
          Write-Host "Version '$version' is valid"

      - name: Build Windows app
        id: build
        env:
          VERSION: ${{ inputs.version }}
        run: |
          # Use the unified build script via bash (Git Bash on Windows)
          bash -c "./build-prod.sh windows --version $env:VERSION"
          echo "setup-name=OximySetup-${{ inputs.version }}.exe" >> $env:GITHUB_OUTPUT

      - name: Create Inno Setup installer (optional)
        working-directory: OximyWindows
        run: |
          $iss = "installer\OximySetup.iss"
          if (Test-Path $iss) {
            (Get-Content $iss) -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ inputs.version }}"' | Set-Content $iss
            $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
            if (Test-Path $innoPath) {
              & $innoPath $iss
            } else {
              Write-Warning "Inno Setup not found, skipping installer creation"
            }
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            OximyWindows/releases/*
            OximyWindows/installer/Output/*.exe
          retention-days: 30

  # ===========================================
  # Create GitHub Release
  # ===========================================
  create-release:
    name: Create Release
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: release-assets/macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release-assets/windows

      - name: List release assets
        run: |
          echo "=== macOS ==="
          ls -la release-assets/macos/ || echo "No macOS files"
          echo ""
          echo "=== Windows ==="
          ls -la release-assets/windows/ || echo "No Windows files"
          ls -la release-assets/windows/releases/ 2>/dev/null || echo "No Velopack releases"
          ls -la release-assets/windows/Output/ 2>/dev/null || echo "No Inno Setup output"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: oximy-v${{ inputs.version }}
          name: Oximy v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            release-assets/macos/Oximy-${{ inputs.version }}.dmg
            release-assets/macos/appcast.xml
            release-assets/windows/releases/*
            release-assets/windows/Output/*.exe
          body: |
            ## Oximy v${{ inputs.version }}

            ### Downloads

            | Platform | Download |
            |----------|----------|
            | macOS (Apple Silicon & Intel) | [Oximy-${{ inputs.version }}.dmg](https://github.com/OximyHQ/mitmproxy/releases/download/oximy-v${{ inputs.version }}/Oximy-${{ inputs.version }}.dmg) |
            | Windows (64-bit) | [OximySetup-${{ inputs.version }}.exe](https://github.com/OximyHQ/mitmproxy/releases/download/oximy-v${{ inputs.version }}/OximySetup-${{ inputs.version }}.exe) |

            ### macOS Compatibility

            - **Apple Silicon (M1/M2/M3/M4)**: Native ARM64 binary
            - **Intel Macs**: Native x86_64 binary (Universal Binary)

            ### Auto-Updates

            Existing installations will be automatically notified of this update.

            - **macOS**: Sparkle framework checks for updates every 24 hours
            - **Windows**: Velopack checks for updates on app startup

            ---

            **Full Changelog**: https://github.com/OximyHQ/mitmproxy/compare/...oximy-v${{ inputs.version }}

      - name: Summary
        run: |
          echo "## Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: oximy-v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release**: ${{ inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "- [macOS DMG](https://github.com/OximyHQ/mitmproxy/releases/download/oximy-v${{ inputs.version }}/Oximy-${{ inputs.version }}.dmg)" >> $GITHUB_STEP_SUMMARY
          echo "- [Windows Installer](https://github.com/OximyHQ/mitmproxy/releases/download/oximy-v${{ inputs.version }}/OximySetup-${{ inputs.version }}.exe)" >> $GITHUB_STEP_SUMMARY
