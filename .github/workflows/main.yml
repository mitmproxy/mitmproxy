name: CI

on:
  push:
    branches:
      - '**'
      - '!dependabot/**'
  pull_request:
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-2
  cancel-in-progress: true

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            py: "3.12"
          - os: windows-latest
            py: "3.12"
            a: 1
          - os: windows-latest
            py: "3.12"
            a: 2
          - os: windows-latest
            py: "3.12"
            a: 3
          - os: windows-latest
            py: "3.12"
            a: 4
          - os: windows-latest
            py: "3.12"
            a: 5
          - os: windows-latest
            py: "3.12"
            a: 6
          - os: windows-latest
            py: "3.12"
            a: 7
          - os: windows-latest
            py: "3.12"
            a: 8
          - os: windows-latest
            py: "3.12"
            a: 9
          - os: windows-latest
            py: "3.12"
            a: 10
          - os: windows-latest
            py: "3.12"
            a: 11
          - os: windows-latest
            py: "3.12"
            a: 12
          - os: windows-latest
            py: "3.12"
            a: 13
          - os: windows-latest
            py: "3.12"
            a: 14
          - os: windows-latest
            py: "3.12"
            a: 15
          - os: windows-latest
            py: "3.12"
            a: 16
          - os: windows-latest
            py: "3.12"
            a: 17
          - os: windows-latest
            py: "3.12"
            a: 18
          - os: windows-latest
            py: "3.12"
            a: 19
    runs-on: ${{ matrix.os }}
    steps:
      - run: printenv
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.py }}
      - run: pip install tox
      - run: tox -e py -- -k test_reverse_http3_and_quic_stream -x
        if: matrix.os != 'ubuntu-latest'
      - name: Run tox -e py (without internet)
        run: |
          # install dependencies (requires internet connectivity)
          tox -e py --notest  
          # run tests with loopback only. We need to sudo for unshare, which means we need an absolute path for tox.
          sudo unshare --net -- sh -c "ip link set lo up; $(which tox) -e py"
        if: matrix.os == 'ubuntu-latest'
      - uses: mhils/better-codecov-action@main
        with:
          arguments: '--file ./coverage.xml --name ${{ matrix.os }}'
